<!DOCTYPE html><html lang="zh-CN" id="theme-mode-light"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="李明元"><title>K8S 快速上手+实践 · 大明哥的博客</title><meta name="description" content="Kubenetes（K8S）简介Kubernetes (K8S) 是什么它是一个为 容器化 应用提供集群部署和管理的开源工具，由 Google 开发。Kubernetes 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。 Google 在 20"><meta name="keywords" content="大明哥,李明元的博客,李明元,博客,blog,Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="https://avatars.githubusercontent.com/u/17492753?v=4" style="width:127px;border-radius:50%"><h3 title=""><a href="/">大明哥的博客</a></h3><div class="description"><p id="yiyan">...</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="http://weibo.com/https://weibo.com/u/5229973867"><i class="fa fa-weibo"></i></a></li><li><a target="_blank" rel="noopener" href="http://github.com/https://github.com/yuan1"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div><div class="by_farbox"><span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"> </span><span>次</span></span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle()"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>K8S 快速上手+实践</a></h3></div><div class="post-content"><h2 id="Kubenetes（K8S）简介"><a href="#Kubenetes（K8S）简介" class="headerlink" title="Kubenetes（K8S）简介"></a>Kubenetes（K8S）简介</h2><h4 id="Kubernetes-K8S-是什么"><a href="#Kubernetes-K8S-是什么" class="headerlink" title="Kubernetes (K8S) 是什么"></a>Kubernetes (K8S) 是什么</h4><p>它是一个为 容器化 应用提供集群部署和管理的开源工具，由 Google 开发。<br>Kubernetes 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。 Google 在 2014 年开源了 Kubernetes 项目</p>
<h4 id="主要特性："><a href="#主要特性：" class="headerlink" title="主要特性："></a>主要特性：</h4><p>高可用，不宕机，自动灾难恢复<br>灰度更新，不影响业务正常运转<br>一键回滚到历史版本<br>方便的伸缩扩展（应用伸缩，机器加减）、提供负载均衡<br>有一个完善的生态</p>
<h4 id="学习课程前提"><a href="#学习课程前提" class="headerlink" title="学习课程前提"></a>学习课程前提</h4><p>熟悉 Docker 的基本使用，如果你还不了解 Docker，先看视频 Docker 快速上手<br>熟悉 Linux 操作系统</p>
<h4 id="不同的应用部署方案"><a href="#不同的应用部署方案" class="headerlink" title="不同的应用部署方案"></a>不同的应用部署方案</h4><p><img src="https://user-images.githubusercontent.com/17492753/200782320-a794f932-767c-4b8b-ad5e-bc7d53e630a0.png" alt="image"></p>
<h5 id="传统部署方式："><a href="#传统部署方式：" class="headerlink" title="传统部署方式："></a>传统部署方式：</h5><p>应用直接在物理机上部署，机器资源分配不好控制，出现Bug时，可能机器的大部分资源被某个应用占用，导致其他应用无法正常运行，无法做到应用隔离。</p>
<h5 id="虚拟机部署"><a href="#虚拟机部署" class="headerlink" title="虚拟机部署"></a>虚拟机部署</h5><p>在单个物理机上运行多个虚拟机，每个虚拟机都是完整独立的系统，性能损耗大。</p>
<h5 id="容器部署"><a href="#容器部署" class="headerlink" title="容器部署"></a>容器部署</h5><p>所有容器共享主机的系统，轻量级的虚拟机，性能损耗小，资源隔离，CPU和内存可按需分配</p>
<h4 id="什么时候需要-Kubernetes"><a href="#什么时候需要-Kubernetes" class="headerlink" title="什么时候需要 Kubernetes"></a>什么时候需要 Kubernetes</h4><p>当你的应用只是跑在一台机器，直接一个 docker + docker-compose 就够了，方便轻松；<br>当你的应用需要跑在 3，4 台机器上，你依旧可以每台机器单独配置运行环境 + 负载均衡器；<br>当你应用访问数不断增加，机器逐渐增加到十几台、上百台、上千台时，每次加机器、软件更新、版本回滚，都会变得非常麻烦、痛不欲生，再也不能好好的摸鱼了，人生浪费在那些没技术含量的重复性工作上。</p>
<p>这时候，Kubernetes 就可以一展身手了，让你轻松管理百万千万台机器的集群。“谈笑间，樯橹灰飞烟灭”，享受着一手掌控所有，年薪百万指日可待。</p>
<p>Kubernates 可以为你提供集中式的管理集群机器和应用，加机器、版本升级、版本回滚，那都是一个命令就搞定的事，不停机的灰度更新，确保高可用、高性能、高扩展。</p>
<h4 id="Kubernetes-集群架构"><a href="#Kubernetes-集群架构" class="headerlink" title="Kubernetes 集群架构"></a>Kubernetes 集群架构</h4><p>部署示意图</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782387-1a4b4bdb-e479-4e99-90ac-eab55831e2a6.png" alt="image"></p>
<h5 id="master"><a href="#master" class="headerlink" title="master"></a>master</h5><p>主节点，控制平台，不需要很高性能，不跑任务，通常一个就行了，也可以开多个主节点来提高集群可用度。</p>
<h5 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h5><p>工作节点，可以是虚拟机或物理计算机，任务都在这里跑，机器性能需要好点；通常都有很多个，可以不断加机器扩大集群；每个工作节点由主节点管理</p>
<h5 id="重要概念-Pod"><a href="#重要概念-Pod" class="headerlink" title="重要概念 Pod"></a>重要概念 Pod</h5><p>豆荚，K8S 调度、管理的最小单位，一个 Pod 可以包含一个或多个容器，每个 Pod 有自己的虚拟IP。一个工作节点可以有多个 pod，主节点会考量负载自动调度 pod 到哪个节点运行。</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782425-002c811d-0790-4750-a02d-0a2efe8ce045.png" alt="image"></p>
<h4 id="Kubernetes-组件"><a href="#Kubernetes-组件" class="headerlink" title="Kubernetes 组件"></a>Kubernetes 组件</h4><p>kube-apiserver API 服务器，公开了 Kubernetes API<br>etcd 键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库<br>kube-scheduler 调度 Pod 到哪个节点运行<br>kube-controller 集群控制器<br>cloud-controller 与云服务商交互</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782466-08f6e611-7b4c-49ba-84f9-88854bd5d8e0.png" alt="image"></p>
<h2 id="安装-Kubernetes-集群"><a href="#安装-Kubernetes-集群" class="headerlink" title="安装 Kubernetes 集群"></a>安装 Kubernetes 集群</h2><h4 id="安装方式介绍"><a href="#安装方式介绍" class="headerlink" title="安装方式介绍"></a>安装方式介绍</h4><p>minikube<br>只是一个 K8S 集群模拟器，只有一个节点的集群，只为测试用，master 和 worker 都在一起</p>
<p>直接用云平台 Kubernetes<br>可视化搭建，只需简单几步就可以创建好一个集群。<br>优点：安装简单，生态齐全，负载均衡器、存储等都给你配套好，简单操作就搞定</p>
<p>裸机安装（Bare Metal）<br>至少需要两台机器（主节点、工作节点个一台），需要自己安装 Kubernetes 组件，配置会稍微麻烦点。<br>可以到各云厂商按时租用服务器，费用低，用完就销毁。<br>缺点：配置麻烦，缺少生态支持，例如负载均衡器、云存储。</p>
<h5 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h5><p>安装非常简单，支持各种平台，安装方法</p>
<blockquote>
<p>需要提前安装好 Docker</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动集群</span></span><br><span class="line">minikube start</span><br><span class="line"><span class="comment"># 查看节点。kubectl 是一个用来跟 K8S 集群进行交互的命令行工具</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment"># 停止集群</span></span><br><span class="line">minikube stop</span><br><span class="line"><span class="comment"># 清空集群</span></span><br><span class="line">minikube delete --all</span><br><span class="line"><span class="comment"># 安装集群可视化 Web UI 控制台</span></span><br><span class="line">minikube dashboard</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="云平台搭建"><a href="#云平台搭建" class="headerlink" title="云平台搭建"></a>云平台搭建</h5><p>腾讯云 TKE（控制台搜索容器）<br>登录阿里云控制台 - 产品搜索 Kubernates</p>
<h5 id="裸机搭建（Bare-Metal）"><a href="#裸机搭建（Bare-Metal）" class="headerlink" title="裸机搭建（Bare Metal）"></a>裸机搭建（Bare Metal）</h5><p>主节点需要组件<br>docker（也可以是其他容器运行时）<br>kubectl 集群命令行交互工具<br>kubeadm 集群初始化工具</p>
<p>工作节点需要组件 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/components/#node-components">文档</a><br>docker（也可以是其他容器运行时）<br>kubelet 管理 Pod 和容器，确保他们健康稳定运行。<br>kube-proxy 网络代理，负责网络相关的工作</p>
<h4 id="裸机安装"><a href="#裸机安装" class="headerlink" title="裸机安装"></a>裸机安装</h4><blockquote>
<p>你也可以试下 <a target="_blank" rel="noopener" href="https://github.com/lework/kainstall">这个项目</a>，用脚本快速搭建 K8S 裸机集群<br>当然，为了更好的理解，你应该先手动搭建一次</p>
</blockquote>
<h5 id="准备安装"><a href="#准备安装" class="headerlink" title="准备安装"></a>准备安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每个节点分别设置对应主机名</span></span><br><span class="line">hostnamectl set-hostname master</span><br><span class="line">hostnamectl set-hostname node1</span><br><span class="line">hostnamectl set-hostname node2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有节点都修改 hosts</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">172.16.32.2 node1</span><br><span class="line">172.16.32.6 node2</span><br><span class="line">172.16.0.4 master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有节点关闭 SELinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i --follow-symlinks <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;</span> /etc/sysconfig/selinux</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有节点确保防火墙关闭</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="添加安装源（所有节点）"><a href="#添加安装源（所有节点）" class="headerlink" title="添加安装源（所有节点）"></a>添加安装源（所有节点）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 k8s 安装源</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">mv</span> kubernetes.repo /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 Docker 安装源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="安装所需组件（所有节点）"><a href="#安装所需组件（所有节点）" class="headerlink" title="安装所需组件（所有节点）"></a>安装所需组件（所有节点）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet kubeadm kubectl docker-ce</span><br></pre></td></tr></table></figure>

<h5 id="启动-kubelet、docker，并设置开机启动（所有节点）"><a href="#启动-kubelet、docker，并设置开机启动（所有节点）" class="headerlink" title="启动 kubelet、docker，并设置开机启动（所有节点）"></a>启动 kubelet、docker，并设置开机启动（所有节点）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="修改-docker-配置（所有节点）"><a href="#修改-docker-配置（所有节点）" class="headerlink" title="修改 docker 配置（所有节点）"></a>修改 docker 配置（所有节点）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubernetes 官方推荐 docker 等使用 systemd 作为 cgroupdriver，否则 kubelet 启动不了</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; daemon.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://ud6340vz.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">mv</span> daemon.json /etc/docker/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="用-kubeadm-初始化集群（仅在主节点跑），"><a href="#用-kubeadm-初始化集群（仅在主节点跑），" class="headerlink" title="用 kubeadm 初始化集群（仅在主节点跑），"></a>用 kubeadm 初始化集群（仅在主节点跑），</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化集群控制台 Control plane</span></span><br><span class="line"><span class="comment"># 失败了可以用 kubeadm reset 重置</span></span><br><span class="line">kubeadm init --image-repository=registry.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记得把 kubeadm join xxx 保存起来</span></span><br><span class="line"><span class="comment"># 忘记了重新获取：kubeadm token create --print-join-command</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制授权文件，以便 kubectl 可以有权限访问集群</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在其他机器上创建 ~/.kube/config 文件也能通过 kubectl 访问到集群</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>有兴趣了解 kubeadm init 具体做了什么的，可以 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/">查看文档</a></p>
</blockquote>
<h5 id="把工作节点加入集群（只在工作节点跑）"><a href="#把工作节点加入集群（只在工作节点跑）" class="headerlink" title="把工作节点加入集群（只在工作节点跑）"></a>把工作节点加入集群（只在工作节点跑）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 172.16.32.10:6443 --token xxx --discovery-token-ca-cert-hash xxx</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h5><p>否则 node 是 NotReady 状态（主节点跑）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h5><p>要在主节点查看（其他节点有安装 kubectl 也可以查看）</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782575-cdbde5f7-c68f-4393-bd54-f2316f95db70.png" alt="image"></p>
<h2 id="部署应用到集群中"><a href="#部署应用到集群中" class="headerlink" title="部署应用到集群中"></a>部署应用到集群中</h2><h4 id="部署应用-YAML-文件"><a href="#部署应用-YAML-文件" class="headerlink" title="部署应用 YAML 文件"></a>部署应用 YAML 文件</h4><p>直接命令运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl run testapp --image=ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pod</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># 定义容器，可以多个</span></span><br><span class="line">  containers:</span><br><span class="line">    - name: test-k8s <span class="comment"># 容器名字</span></span><br><span class="line">      image: ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1 <span class="comment"># 镜像</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Deployment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># 部署名字</span></span><br><span class="line">  name: test-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  <span class="comment"># 用来查找关联的 Pod，所有标签都匹配才行</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: test-k8s</span><br><span class="line">  <span class="comment"># 定义 Pod 相关数据</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: test-k8s</span><br><span class="line">    spec:</span><br><span class="line">      <span class="comment"># 定义容器，可以多个</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: test-k8s <span class="comment"># 容器名字</span></span><br><span class="line">        image: ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1 <span class="comment"># 镜像</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="Deployment-通过-label-关联起来-Pods"><a href="#Deployment-通过-label-关联起来-Pods" class="headerlink" title="Deployment 通过 label 关联起来 Pods"></a>Deployment 通过 label 关联起来 Pods</h5><p><img src="https://user-images.githubusercontent.com/17492753/200782635-f081ea33-b61d-45f0-8324-2dbdf591739b.png" alt="image"></p>
<h4 id="部署应用演示"><a href="#部署应用演示" class="headerlink" title="部署应用演示"></a>部署应用演示</h4><p>部署一个 nodejs web 应用，源码地址：<a target="_blank" rel="noopener" href="https://github.com/gzyunke/test-k8s">Github</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署应用</span></span><br><span class="line">kubectl apply -f app.yaml</span><br><span class="line"><span class="comment"># 查看 deployment</span></span><br><span class="line">kubectl get deployment</span><br><span class="line"><span class="comment"># 查看 pod</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"><span class="comment"># 查看 pod 详情</span></span><br><span class="line">kubectl describe pod pod-name</span><br><span class="line"><span class="comment"># 查看 log</span></span><br><span class="line">kubectl logs pod-name</span><br><span class="line"><span class="comment"># 进入 Pod 容器终端， -c container-name 可以指定进入哪个容器。</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod-name -- bash</span><br><span class="line"><span class="comment"># 伸缩扩展副本</span></span><br><span class="line">kubectl scale deployment test-k8s --replicas=5</span><br><span class="line"><span class="comment"># 把集群内端口映射到节点</span></span><br><span class="line">kubectl port-forward pod-name 8090:8080</span><br><span class="line"><span class="comment"># 查看历史</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment test-k8s</span><br><span class="line"><span class="comment"># 回到上个版本</span></span><br><span class="line">kubectl rollout undo deployment test-k8s</span><br><span class="line"><span class="comment"># 回到指定版本</span></span><br><span class="line">kubectl rollout undo deployment test-k8s --to-revision=2</span><br><span class="line"><span class="comment"># 删除部署</span></span><br><span class="line">kubectl delete deployment test-k8s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Pod-报错解决"><a href="#Pod-报错解决" class="headerlink" title="Pod 报错解决"></a>Pod 报错解决</h5><p>如果你运行 kubectl describe pod/pod-name 发现 Events 中有下面这个错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">networkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">&quot;test-k8s-68bb74d654-mc6b9_default&quot;</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>在每个节点创建文件/run/flannel/subnet.env写入以下内容即可解决</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="更多命令"><a href="#更多命令" class="headerlink" title="更多命令"></a>更多命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看全部</span></span><br><span class="line">kubectl get all</span><br><span class="line"><span class="comment"># 重新部署</span></span><br><span class="line">kubectl rollout restart deployment test-k8s</span><br><span class="line"><span class="comment"># 命令修改镜像，--record 表示把这个命令记录到操作历史中</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment test-k8s test-k8s=ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v2-with-error --record</span><br><span class="line"><span class="comment"># 暂停运行，暂停后，对 deployment 的修改不会立刻生效，恢复后才应用设置</span></span><br><span class="line">kubectl rollout pause deployment test-k8s</span><br><span class="line"><span class="comment"># 恢复</span></span><br><span class="line">kubectl rollout resume deployment test-k8s</span><br><span class="line"><span class="comment"># 输出到文件</span></span><br><span class="line">kubectl get deployment test-k8s -o yaml &gt;&gt; app2.yaml</span><br><span class="line"><span class="comment"># 删除全部资源</span></span><br><span class="line">kubectl delete all --all</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更多官网关于 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a> 的介绍<br>将 Pod 指定到某个节点运行：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector">nodeselector</a><br>限定 CPU、内存总量：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/policy/resource-quotas/#%E8%AE%A1%E7%AE%97%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D">文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">env</span>: <span class="built_in">test</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disktype: ssd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="工作负载分类"><a href="#工作负载分类" class="headerlink" title="工作负载分类"></a>工作负载分类</h4><p>Deployment<br>适合无状态应用，所有pod等价，可替代</p>
<p>StatefulSet<br>有状态的应用，适合数据库这种类型。</p>
<p>DaemonSet<br>在每个节点上跑一个 Pod，可以用来做节点监控、节点日志收集等</p>
<p>Job &amp; CronJob<br>Job 用来表达的是一次性的任务，而 CronJob 会根据其时间规划反复运行。<br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/">文档</a></p>
<h4 id="现存问题"><a href="#现存问题" class="headerlink" title="现存问题"></a>现存问题</h4><p>每次只能访问一个 pod，没有负载均衡自动转发到不同 pod<br>访问还需要端口转发<br>Pod 重创后 IP 变了，名字也变了</p>
<p>下节我们讲解如何解决。</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><p>Service 通过 label 关联对应的 Pod</p>
<p>Servcie 生命周期不跟 Pod 绑定，不会因为 Pod 重创改变 IP</p>
<p>提供了负载均衡功能，自动转发流量到不同 Pod</p>
<p>可对集群外部提供访问端口</p>
<p>集群内部可通过服务名字访问</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782806-4d1f2180-08fc-48e8-93a2-d478ef2d5faa.png" alt="image"></p>
<h4 id="创建-Service"><a href="#创建-Service" class="headerlink" title="创建 Service"></a>创建 Service</h4><p>创建 一个 Service，通过标签test-k8s跟对应的 Pod 关联上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> service.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: test-k8s</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: test-k8s</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080        <span class="comment"># 本 Service 的端口</span></span><br><span class="line">      targetPort: 8080  <span class="comment"># 容器端口</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>应用配置 <code>kubectl apply -f service.yaml</code><br>查看服务 <code>kubectl get svc</code></p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782911-3887834f-47db-4608-904d-7cdcadc46a72.png" alt="image"></p>
<p>查看服务详情 <code>kubectl describe svc test-k8s</code><br>可以发现 Endpoints 是各个 Pod 的 IP，也就是他会把流量转发到这些节点。</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200782937-a05f833d-272c-430d-8d5d-069c8cd30b0b.png" alt="image"></p>
<p>服务的默认类型是ClusterIP，只能在集群内部访问，我们可以进入到 Pod 里面访问：</p>
<p><code>kubectl exec -it pod-name -- bash curl http://test-k8s:8080</code></p>
<p>如果要在集群外部访问，可以通过端口转发实现（只适合临时测试用）：</p>
<p><code>kubectl port-forward service/test-k8s 8888:8080</code></p>
<p>如果你用 minikube，也可以这样</p>
<p><code>minikube service test-k8s</code></p>
<h4 id="对外暴露服务"><a href="#对外暴露服务" class="headerlink" title="对外暴露服务"></a>对外暴露服务</h4><p>上面我们是通过端口转发的方式可以在外面访问到集群里的服务，如果想要直接把集群服务暴露出来，我们可以使用NodePort 和 Loadbalancer 类型的 Service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: test-k8s</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: test-k8s</span><br><span class="line">  <span class="comment"># 默认 ClusterIP 集群内可访问，NodePort 节点可访问，LoadBalancer 负载均衡模式（需要负载均衡器才可用）</span></span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080        <span class="comment"># 本 Service 的端口</span></span><br><span class="line">      targetPort: 8080  <span class="comment"># 容器端口</span></span><br><span class="line">      nodePort: 31000   <span class="comment"># 节点端口，范围固定 30000 ~ 32767</span></span><br></pre></td></tr></table></figure>

<p>应用配置 <code>kubectl apply -f service.yaml</code><br>在节点上，我们可以 <code>curl http://localhost:31000/hello/easydoc</code> 访问到应用<br>并且是有负载均衡的，网页的信息可以看到被转发到了不同的 Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello easydoc </span><br><span class="line"></span><br><span class="line">IP lo172.17.0.8, hostname: test-k8s-68bb74d654-962lh</span><br></pre></td></tr></table></figure>

<p>如果你是用 minikube，因为是模拟集群，你的电脑并不是节点，节点是 minikube 模拟出来的，所以你并不能直接在电脑上访问到服务</p>
<p>Loadbalancer 也可以对外提供服务，这需要一个负载均衡器的支持，因为它需要生成一个新的 IP 对外服务，否则状态就一直是 pendding</p>
<h4 id="多端口"><a href="#多端口" class="headerlink" title="多端口"></a>多端口</h4><p>多端口时必须配置 name <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#multi-port-services">文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: test-k8s</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: test-k8s</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080        <span class="comment"># 本 Service 的端口</span></span><br><span class="line">      name: test-k8s    <span class="comment"># 必须配置</span></span><br><span class="line">      targetPort: 8080  <span class="comment"># 容器端口</span></span><br><span class="line">      nodePort: 31000   <span class="comment"># 节点端口，范围固定 30000 ~ 32767</span></span><br><span class="line">    - port: 8090</span><br><span class="line">      name: test-other</span><br><span class="line">      targetPort: 8090</span><br><span class="line">      nodePort: 32000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>ClusterIP<br>默认的，仅在集群内可用</p>
<p>NodePort<br>暴露端口到节点，提供了集群外部访问的入口<br>端口范围固定 30000 ~ 32767</p>
<p>LoadBalancer<br>需要负载均衡器（通常都需要云服务商提供，裸机可以安装 <a target="_blank" rel="noopener" href="https://metallb.universe.tf/">METALLB</a> 测试）<br>会额外生成一个 IP 对外服务<br>K8S 支持的负载均衡器：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#internal-load-balancer">负载均衡器</a></p>
<p>Headless<br>适合数据库<br>clusterIp 设置为 None 就变成 Headless 了，不会再分配 IP，后面会再讲到具体用法 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#headless-services">文档</a></p>
<h2 id="StatefuSet"><a href="#StatefuSet" class="headerlink" title="StatefuSet"></a>StatefuSet</h2><h4 id="什么是-StatefulSet"><a href="#什么是-StatefulSet" class="headerlink" title="什么是 StatefulSet"></a>什么是 StatefulSet</h4><p>StatefulSet 是用来管理有状态的应用，例如数据库。<br>前面我们部署的应用，都是不需要存储数据，不需要记住状态的，可以随意扩充副本，每个副本都是一样的，可替代的。<br>而像数据库、Redis 这类有状态的，则不能随意扩充副本。<br>StatefulSet 会固定每个 Pod 的名字</p>
<h4 id="部署-StatefulSet-类型的-Mongodb"><a href="#部署-StatefulSet-类型的-Mongodb" class="headerlink" title="部署 StatefulSet 类型的 Mongodb"></a>部署 StatefulSet 类型的 Mongodb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongodb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongodb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mongo</span><br><span class="line">          image: mongo:4.4</span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: mongodb</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  <span class="comment"># HeadLess</span></span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">    - port: 27017</span><br><span class="line">      targetPort: 27017</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f mongo.yaml</code></p>
<h4 id="StatefulSet-特性"><a href="#StatefulSet-特性" class="headerlink" title="StatefulSet 特性"></a>StatefulSet 特性</h4><p>Service 的 CLUSTER-IP 是空的，Pod 名字也是固定的。<br>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的。<br>Pod 重建不会改变名字，除了IP，所以不要用IP直连</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200783062-5d480f8b-fe92-48f8-9d51-96c3ff04253d.png" alt="image"></p>
<p>Endpoints 会多一个 hostname!</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200783101-56ea3ca5-64f2-47cc-8152-4ec186d28fbc.png" alt="image"></p>
<p>访问时，如果直接使用 Service 名字连接，会随机转发请求<br>要连接指定 Pod，可以这样 <code>pod-name.service-name</code><br>运行一个临时 Pod 连接数据测试下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl run mongodb-client --<span class="built_in">rm</span> --<span class="built_in">tty</span> -i --restart=<span class="string">&#x27;Never&#x27;</span> --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --<span class="built_in">command</span> -- bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Web-应用连接-Mongodb"><a href="#Web-应用连接-Mongodb" class="headerlink" title="Web 应用连接 Mongodb"></a>Web 应用连接 Mongodb</h4><p>在集群内部，我们可以通过服务名字访问到不同的服务<br>指定连接第一个：mongodb-0.mongodb</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200783230-9810d1fd-54eb-48c8-817e-06ed1522551e.png" alt="image"><br><img src="https://user-images.githubusercontent.com/17492753/200783272-c3f70949-d169-45e2-aa94-a8cfeb9cf97f.png" alt="image"></p>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>pod 重建后，数据库的内容丢失了<br>下节，我们讲解如何解决这个问题。</p>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>kubernetes 集群不会为你处理数据的存储，我们可以为数据库挂载一个磁盘来确保数据的安全。<br>你可以选择云存储、本地磁盘、NFS。</p>
<ul>
<li>  本地磁盘：可以挂载某个节点上的目录，但是这需要限定 pod 在这个节点上运行</li>
<li>  云存储：不限定节点，不受集群影响，安全稳定；需要云服务商提供，裸机集群是没有的。</li>
<li>  NFS：不限定节点，不受集群影响</li>
</ul>
<h4 id="hostPath-挂载示例"><a href="#hostPath-挂载示例" class="headerlink" title="hostPath 挂载示例"></a>hostPath 挂载示例</h4><p>把节点上的一个目录挂载到 Pod，但是已经不推荐使用了，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath">文档</a><br>配置方式简单，需要手动指定 Pod 跑在某个固定的节点。<br>仅供单节点测试使用；不适用于多节点集群。<br>minikube 提供了 hostPath 存储，<a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/handbook/persistent_volumes/">文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongodb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongodb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mongo</span><br><span class="line">          image: mongo:4.4</span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /data/db <span class="comment"># 容器里面的挂载路径</span></span><br><span class="line">              name: mongo-data    <span class="comment"># 卷名字，必须跟下面定义的名字一致</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: mongo-data              <span class="comment"># 卷名字</span></span><br><span class="line">          hostPath:</span><br><span class="line">            path: /data/mongo-data      <span class="comment"># 节点上的路径</span></span><br><span class="line">            <span class="built_in">type</span>: DirectoryOrCreate     <span class="comment"># 指向一个目录，不存在时自动创建</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="更高级的抽象"><a href="#更高级的抽象" class="headerlink" title="更高级的抽象"></a>更高级的抽象</h4><p><img src="https://user-images.githubusercontent.com/17492753/200783315-3aec0093-05f9-4716-847c-e772b5e687e4.png" alt="image"></p>
<h5 id="Storage-Class-SC"><a href="#Storage-Class-SC" class="headerlink" title="Storage Class (SC)"></a>Storage Class (SC)</h5><p>将存储卷划分为不同的种类，例如：SSD，普通磁盘，本地磁盘，按需使用。<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: slow</span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">parameters:</span><br><span class="line">  <span class="built_in">type</span>: io1</span><br><span class="line">  iopsPerGB: <span class="string">&quot;10&quot;</span></span><br><span class="line">  fsType: ext4</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="Persistent-Volume-PV"><a href="#Persistent-Volume-PV" class="headerlink" title="Persistent Volume (PV)"></a>Persistent Volume (PV)</h5><p>描述卷的具体信息，例如磁盘大小，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#access-modes">访问模式</a>。<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">文档</a>，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">类型</a>，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local">Local 示例</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodata</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">  volumeMode: Filesystem  <span class="comment"># Filesystem（文件系统） Block（块）</span></span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce       <span class="comment"># 卷可以被一个节点以读写方式挂载</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    path: /root/data</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      <span class="comment"># 通过 hostname 限定在某个节点创建存储卷</span></span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">            - key: kubernetes.io/hostname</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">                - node2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Persistent-Volume-Claim-PVC"><a href="#Persistent-Volume-Claim-PVC" class="headerlink" title="Persistent Volume Claim (PVC)"></a>Persistent Volume Claim (PVC)</h5><p>对存储需求的一个申明，可以理解为一个申请单，系统根据这个申请单去找一个合适的 PV<br>还可以根据 PVC 自动创建 PV。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodata</span><br><span class="line">spec:</span><br><span class="line">  accessModes: [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  storageClassName: <span class="string">&quot;local-storage&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="为什么要这么多层抽象"><a href="#为什么要这么多层抽象" class="headerlink" title="为什么要这么多层抽象"></a>为什么要这么多层抽象</h5><ul>
<li>  更好的分工，运维人员负责提供好存储，开发人员不需要关注磁盘细节，只需要写一个申请单。</li>
<li>  方便云服务商提供不同类型的，配置细节不需要开发者关注，只需要一个申请单。</li>
<li>  <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/dynamic-provisioning/">动态创建</a>，开发人员写好申请单后，供应商可以根据需求自动创建所需存储卷。</li>
</ul>
<h4 id="腾讯云示例"><a href="#腾讯云示例" class="headerlink" title="腾讯云示例"></a>腾讯云示例</h4><p><img src="https://user-images.githubusercontent.com/17492753/200783390-9cf8e34f-98bb-4480-83f9-3e981b0ed020.png" alt="image"></p>
<h4 id="本地磁盘示例"><a href="#本地磁盘示例" class="headerlink" title="本地磁盘示例"></a>本地磁盘示例</h4><p>不支持动态创建，需要提前创建好</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongodb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongodb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        image: mongo:5.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: mongo</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - mountPath: /data/db</span><br><span class="line">            name: mongo-data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: mongo-data</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">             claimName: mongodata</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - port: 27017</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 27017</span><br><span class="line">  selector:</span><br><span class="line">    app: mongodb</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">provisioner: kubernetes.io/no-provisioner</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodata</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">  volumeMode: Filesystem  <span class="comment"># Filesystem（文件系统） Block（块）</span></span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce       <span class="comment"># 卷可以被一个节点以读写方式挂载</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    path: /root/data</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      <span class="comment"># 通过 hostname 限定在某个节点创建存储卷</span></span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">            - key: kubernetes.io/hostname</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">                - node2</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodata</span><br><span class="line">spec:</span><br><span class="line">  accessModes: [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  storageClassName: <span class="string">&quot;local-storage&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><p>当前数据库的连接地址是写死在代码里的，另外还有数据库的密码需要配置。<br>下节，我们讲解如何解决。</p>
<h2 id="ConfigMap-amp-Secret"><a href="#ConfigMap-amp-Secret" class="headerlink" title="ConfigMap &amp; Secret"></a>ConfigMap &amp; Secret</h2><h4 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h4><p>数据库连接地址，这种可能根据部署环境变化的，我们不应该写死在代码里。<br>Kubernetes 为我们提供了 ConfigMap，可以方便的配置一些变量。<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/configmap/">文档</a><br><code>configmap.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-config</span><br><span class="line">data:</span><br><span class="line">  mongoHost: mongodb-0.mongodb</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用 kubectl apply -f configmap.yaml </span></span><br><span class="line"><span class="comment"># 查看 kubectl get configmap mongo-config -o yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/17492753/200783585-0573f6ef-c497-4d97-8895-0b95c4b3562a.png" alt="image"></p>
<h4 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h4><p>一些重要数据，例如密码、TOKEN，我们可以放到 secret 中。<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">文档</a>，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#tls-secret">配置证书</a></p>
<blockquote>
<p>注意，数据要进行 Base64 编码。<a target="_blank" rel="noopener" href="https://tools.fun/base64.html">Base64 工具</a></p>
</blockquote>
<p><code>secret.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-secret</span><br><span class="line"><span class="comment"># Opaque 用户定义的任意数据，更多类型介绍 https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-types</span></span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  <span class="comment"># 数据要 base64。https://tools.fun/base64.html</span></span><br><span class="line">  mongo-username: bW9uZ291c2Vy</span><br><span class="line">  mongo-password: bW9uZ29wYXNz</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用 kubectl apply -f secret.yaml </span></span><br><span class="line"><span class="comment"># 查看 kubectl get secret mongo-secret -o yaml</span></span><br></pre></td></tr></table></figure>


<p><img src="https://user-images.githubusercontent.com/17492753/200783643-9477a66a-feb2-46fa-b7d6-31bf46c654bb.png" alt="image"></p>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><h5 id="作为环境变量使用"><a href="#作为环境变量使用" class="headerlink" title="作为环境变量使用"></a>作为环境变量使用</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongodb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongodb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mongo</span><br><span class="line">          image: mongo:4.4</span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          <span class="built_in">env</span>:</span><br><span class="line">          - name: MONGO_INITDB_ROOT_USERNAME</span><br><span class="line">            valueFrom:</span><br><span class="line">              secretKeyRef:</span><br><span class="line">                name: mongo-secret</span><br><span class="line">                key: mongo-username</span><br><span class="line">          - name: MONGO_INITDB_ROOT_PASSWORD</span><br><span class="line">            valueFrom:</span><br><span class="line">              secretKeyRef:</span><br><span class="line">                name: mongo-secret</span><br><span class="line">                key: mongo-password</span><br><span class="line">          <span class="comment"># Secret 的所有数据定义为容器的环境变量，Secret 中的键名称为 Pod 中的环境变量名称</span></span><br><span class="line">          <span class="comment"># envFrom:</span></span><br><span class="line">          <span class="comment"># - secretRef:</span></span><br><span class="line">          <span class="comment">#     name: mongo-secret</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="挂载为文件（更适合证书文件）"><a href="#挂载为文件（更适合证书文件）" class="headerlink" title="挂载为文件（更适合证书文件）"></a>挂载为文件（更适合证书文件）</h5><p>挂载后，会在容器中对应路径生成文件，一个 key 一个文件，内容就是 value，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod">文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mypod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mypod</span><br><span class="line">    image: redis</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: foo</span><br><span class="line">      mountPath: <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: foo</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Helm-amp-命名空间"><a href="#Helm-amp-命名空间" class="headerlink" title="Helm &amp; 命名空间"></a>Helm &amp; 命名空间</h2><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p><code>Helm</code>类似 npm，pip，docker hub, 可以理解为是一个软件库，可以方便快速的为我们的集群安装一些第三方软件。<br>使用 Helm 我们可以非常方便的就搭建出来 MongoDB / MySQL 副本集群，YAML 文件别人都给我们写好了，直接使用。<a target="_blank" rel="noopener" href="https://helm.sh/zh/">官网</a>，<a target="_blank" rel="noopener" href="https://artifacthub.io/">应用中心</a></p>
<h4 id="安装-Helm"><a href="#安装-Helm" class="headerlink" title="安装 Helm"></a>安装 Helm</h4><p>安装 <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/intro/install/">文档</a>  </p>
<p><code>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</code></p>
<h4 id="安装-MongoDB-示例"><a href="#安装-MongoDB-示例" class="headerlink" title="安装 MongoDB 示例"></a>安装 MongoDB 示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm install my-mongo bitnami/mongodb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定密码和架构</span></span><br><span class="line">helm install my-mongo bitnami/mongodb --<span class="built_in">set</span> architecture=<span class="string">&quot;replicaset&quot;</span>,auth.rootPassword=<span class="string">&quot;mongopass&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">helm <span class="built_in">ls</span></span><br><span class="line">heml delete my-mongo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看密码</span></span><br><span class="line">kubectl get secret my-mongo-mongodb -o json</span><br><span class="line">kubectl get secret my-mongo-mongodb -o yaml &gt; secret.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时运行一个包含 mongo client 的 debian 系统</span></span><br><span class="line">kubectl run mongodb-client --<span class="built_in">rm</span> --<span class="built_in">tty</span> -i --restart=<span class="string">&#x27;Never&#x27;</span> --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --<span class="built_in">command</span> -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进去 mongodb</span></span><br><span class="line">mongo --host <span class="string">&quot;my-mongo-mongodb&quot;</span> -u root -p mongopass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以转发集群里的端口到宿主机访问 mongodb</span></span><br><span class="line">kubectl port-forward svc/my-mongo-mongodb 27017:27018</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><p>如果一个集群中部署了多个应用，所有应用都在一起，就不太好管理，也可以导致名字冲突等。<br>我们可以使用 namespace 把应用划分到不同的命名空间，跟代码里的 namespace 是一个概念，只是为了划分空间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建命名空间 kubectl create namespace testapp </span></span><br><span class="line"><span class="comment"># 部署应用到指定的命名空间 kubectl apply -f app.yml --namespace testapp </span></span><br><span class="line"><span class="comment"># 查询 kubectl get pod --namespace kube-system</span></span><br></pre></td></tr></table></figure>

<p>可以用 <a target="_blank" rel="noopener" href="https://github.com/ahmetb/kubectx">kubens</a> 快速切换 namespace</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换命名空间 kubens kube-system </span></span><br><span class="line"><span class="comment"># 回到上个命名空间 kubens - </span></span><br><span class="line"><span class="comment"># 切换集群 kubectx minikube</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/17492753/200783766-3b883090-02e4-4836-acf6-3d4d7e687c8d.png" alt="image"></p>
<h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p>Ingress 为外部访问集群提供了一个 <strong>统一</strong> 入口，避免了对外暴露集群端口；<br>功能类似 Nginx，可以根据域名、路径把请求转发到不同的 Service。<br>可以配置 https</p>
<p><strong>跟 LoadBalancer 有什么区别？</strong><br>LoadBalancer 需要对外暴露端口，不安全；<br>无法根据域名、路径转发流量到不同 Service，多个 Service 则需要开多个 LoadBalancer；<br>功能单一，无法配置 https</p>
<p><img src="https://user-images.githubusercontent.com/17492753/200783827-2a49c05b-6b3f-4176-b1ce-170482b1db19.png" alt="image"></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>要使用 Ingress，需要一个负载均衡器 + Ingress Controller<br>如果是裸机（bare metal) 搭建的集群，你需要自己安装一个负载均衡插件，可以安装 <a target="_blank" rel="noopener" href="https://metallb.universe.tf/">METALLB</a><br>如果是云服务商，会自动给你配置，否则你的外部 IP 会是 “pending” 状态，无法使用。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">Ingress</a><br>Minikube 中部署 Ingress Controller：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">nginx</a><br>Helm 安装： <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">Nginx</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: simple-example</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: tools.fun</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /easydoc</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: service1</span><br><span class="line">            port:</span><br><span class="line">              number: 4200</span><br><span class="line">      - path: /svnbucket</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: service2</span><br><span class="line">            port:</span><br><span class="line">              number: 8080</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="腾讯云配置-Ingress-演示"><a href="#腾讯云配置-Ingress-演示" class="headerlink" title="腾讯云配置 Ingress 演示"></a>腾讯云配置 Ingress 演示</h4><p><img src="https://user-images.githubusercontent.com/17492753/200783885-2f2451f3-b52e-4d0a-abbc-43707aeb4037.png" alt="image"></p>
<h2 id="其他补充"><a href="#其他补充" class="headerlink" title="其他补充"></a>其他补充</h2><p>kubernates 可以管理大量的容器化应用，方便的进行伸缩扩展集群，随时回退版本。<br>kubernates 需要云厂商的支持才是完整的，好在当前各大云厂商都已经提供了 k8s 集群服务，生态很完善，非常方便。<br>我们自己搭建的叫裸机，用来做测试、学习很好，可以把自己淘汰的电脑用起来搭建出一个集群玩玩。</p>
<h4 id="WEB-可视化管理集群"><a href="#WEB-可视化管理集群" class="headerlink" title="WEB 可视化管理集群"></a>WEB 可视化管理集群</h4><p>如果你觉得命令行管理集群太麻烦，你可以用 Helm 快速搭建一个 <a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/k8s-dashboard/kubernetes-dashboard">kubernates-dashboard</a>，这样你就有了一个 WEB 界面，可以可视化的进行一些操作和管理。<br>如果是 minikube 更加简单，一个命令<code>minikube dashboard</code>就好了。</p>
<h4 id="数据库更好的做法"><a href="#数据库更好的做法" class="headerlink" title="数据库更好的做法"></a>数据库更好的做法</h4><p>数据库这种有状态的应用，更好的做法是直接使用云厂商提供的数据库，运行会更加稳定，也有完善的数据备份。</p>
<h4 id="用脚本搭建集群"><a href="#用脚本搭建集群" class="headerlink" title="用脚本搭建集群"></a>用脚本搭建集群</h4><p>Github 上有用户已经把裸机搭建需要做的工作写成了脚本，一个脚本就帮你初始化好集群工作：<a target="_blank" rel="noopener" href="https://github.com/lework/kainstall">kainstall</a></p>
<p><a target="_blank" rel="noopener" href="https://k8s.easydoc.net/doc/28366845/6GiNOzyZ/9EX8Cp45">引用来源</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-11-09</span><i class="fa fa-comment-o"></i><a href="/posts/1ebe624a.html#comments">评论</a><i class="fa fa-tag"></i><a class="tag" href="/tags/Kubenetes/" title="Kubenetes">Kubenetes </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:;" onclick="javascript:join_favorite()"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/posts/a54b9bb8.html" title="ArchLinux下Navicat Premium 15安装与激活">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/posts/823e52b4.html" title="摄影入门理论笔记">下一篇</a></li></ul></div><a id="comments"></a><div id="gitalk_container" style="margin:0 30px;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
    title: "K8S 快速上手+实践",
    clientID: "cb160053da3741b7f5ff",
    clientSecret: "a88a60c126a9c12e1163d5b4d8d1c4622a60ea0f",
    repo: "yuan1.github.io",
    owner: "yuan1",
    admin: ["yuan1"],
    id: location.pathname.slice(0, 50),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
})
gitalk.render("gitalk_container")</script></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/script.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script></body></html>